# NeoPixDot 光链像素

一款带独立供电系统的级联式WS2812像素模拟模块，专为解决WS2812协议长距离/大尺寸传输不稳定问题设计，支持脱线独立工作，可级联拼接成超大尺寸WS2812显示屏幕。

## 🌟 核心特性
### 硬件特性
- **主控核心**：RP2040系列芯片，高性能且适配MicroPython开发
- **显示单元**：4x4矩阵WS2812 RGB灯，搭配均光膜呈现“单个像素点”视觉效果
- **供电系统**：板载IP5407充放电单元+锂电池，支持USB充电/电池供电自动切换
- **级联设计**：双串口按“移位传输”逻辑级联，支持多模块拼接扩展

### 软件特性
- **UART数据处理**：解析RGB数据控制WS2812灯带，自动转发剩余数据至下一级模块
- **电池监测**：ADC采集电池电压+滑动滤波算法，低电压时红灯闪烁告警并禁用UART控灯
- **稳定保障**：集成看门狗（WDT）定时喂狗防程序卡死，环形缓冲区+中断安全调度确保UART数据传输稳定
- **灯效支持**：正常电压下自动执行彩虹流动灯效，低电压触发红灯闪烁告警
- **调试友好**：可配置调试打印开关，计时装饰器辅助性能分析

## 🛠️ 硬件说明
| 组件          | 规格/型号               | 功能说明                     |
|---------------|-------------------------|------------------------------|
| 主控芯片      | RP2040                  | 核心控制，运行MicroPython    |
| RGB灯珠       | 4x4矩阵WS2812           | 模拟单个像素点显色           |
| 充放电芯片    | IP5407                  | 锂电池充放电管理             |
| 电压采集      | ADC（GP26）             | 监测电池电压（1/2分压采样）  |
| 串口          | UART0（接收）/UART1（转发） | 级联数据传输                 |

## 💻 软件说明
### 核心功能逻辑
1. **UART级联传输**：主控发送全量像素数据，模块解析自身RGB信息后，转发剩余数据至下一级
2. **电池电压监测**：100ms周期采样电压，5次滑动滤波去噪，低电压（3.4V）时红灯闪烁，禁用UART控灯；电压恢复后自动解除限制
3. **看门狗保障**：5秒超时看门狗，1秒周期定时喂狗+主循环喂狗，防止程序卡死
4. **灯效控制**：上电检测电压正常则执行彩虹流动灯效，低电压触发红灯闪烁，支持UART解析RGB数据实时控灯

### 代码关键模块
- `RingBuffer`：环形缓冲区，解决UART数据接收满/空歧义问题，保障中断上下文数据安全
- `read_battery_adc`：电池电压采样+滑动滤波，提升电压检测稳定性
- `uart_idle_callback`：UART空闲中断回调，接收数据并调度处理逻辑
- `rainbow_flow`：彩虹流动灯效实现，长操作前手动喂狗避免看门狗超时
- `wdt_feed_callback`：看门狗喂狗回调，定时重置超时计数器

## 🚀 使用方法
### 1. 供电
- USB充电：通过USB接口为锂电池充电，IP5407自动管理充放电
- 电池供电：脱线状态下由锂电池供电，支持独立工作

### 2. 模块级联
- 将前一级模块的UART转发口（UART1）连接至下一级的UART接收口（UART0）
- 主控发送全量像素数据，每个模块自动解析自身RGB数据，转发剩余数据至下一级

### 3. 数据传输
- UART波特率：115200
- 数据格式：前3字节为当前模块RGB值，剩余字节为下一级模块数据
- 示例：发送`0xFF000000FF00`，第一个模块显示红色，第二个模块显示绿色

## ⚠️ 注意事项
1. 电池低电压阈值为3.4V，低电时请及时充电，避免损坏电池
2. 调试模式可通过`DEBUG_ENABLE`开关开启/关闭，上线建议关闭以节省资源
3. 长耗时操作（如彩虹灯效、上电电压检测）会手动喂狗，避免看门狗超时重启